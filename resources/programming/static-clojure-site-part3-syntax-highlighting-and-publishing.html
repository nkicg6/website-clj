<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdf8bc1f">Part 3: Syntax highlighting and org-mode publishing</a>
<ul>
<li><a href="#orgcdd698a">org-workflow: syntax highlighting</a>
<ul>
<li><a href="#org3c805c1">Links</a></li>
</ul>
</li>
<li><a href="#orgbc4ad9b">publishing</a>
<ul>
<li><a href="#orga65a50c">Hosting on Github Pages</a></li>
<li><a href="#org32673ac">one push publishing with Leiningen :alias</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org4db12c3">References</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdf8bc1f" class="outline-2">
<h2 id="orgdf8bc1f">Part 3: Syntax highlighting and org-mode publishing</h2>
<div class="outline-text-2" id="text-orgdf8bc1f">
</div><div id="outline-container-orgcdd698a" class="outline-3">
<h3 id="orgcdd698a">org-workflow: syntax highlighting</h3>
<div class="outline-text-3" id="text-orgcdd698a">
<p>
   <a href="https://cjohansen.no/building-static-sites-in-clojure-with-stasis/">Christian Johanson</a> has an excellent description of formatting markdown fenced code blocks with pygments for nice display on his static site. His approach uses pygments and enliven and is very detailed and nice. However, the amazing <code>org-mode</code> takes care of syntax highlighting for me when I add <code>(setq org-src-fontify-natively t)</code> to my <code>config.org</code>. So here I will just test it real quick and see how it looks.<br />
In my HTML file, I will add a clojure code block like so:<br />
</p>

<pre class="example">

#+OPTIONS: \n:1 toc:nil num:0 todo:nil ^:{}
#+HTML_CONTAINER: div




;* This is a test post
Here is a test post and a link to an image. 


[[file:~/personal_projects/website-clj/resources/public/img/test-img.png]]

And below is a test code block. 

#+BEGIN_SRC clojure 
(defn format-images [html]
  (str/replace html #"file:///Users/Nick/personal_projects/website-clj/resources/public" ""))

;; main pages function.
(defn html-pages [pages]
  (zipmap (map #(str/replace % #"\.html$" "") (keys pages))
          (map #(fn [req] (layout-base-header req %))
               (map format-images (vals pages)))))

#+END_SRC

How does it look?

</pre>

<p>
This renders upon <code>M-x org-publish-project clj-site</code> to look like this:<br />
</p>


<div class="figure">
<p><img src="img/syntax-highlighting.png" alt="syntax-highlighting.png" /><br />
</p>
</div>

<p>
<code>org-src-fontify-natively</code> uses the currently active theme to highlight your source code. I just exported this using the <a href="https://github.com/fniessen/emacs-leuven-theme">Leuven theme</a> (great for org-mode) and I like the way it looks. However, if I wanted to change it and use <code>enliven</code> with <code>pygments</code>, I would probably use some emacs-lisp code and packages such as those described here: <a href="https://emacs.stackexchange.com/questions/31439/how-to-get-colored-syntax-highlighting-of-code-blocks-in-asynchronous-org-mode-e">https://emacs.stackexchange.com/questions/31439/how-to-get-colored-syntax-highlighting-of-code-blocks-in-asynchronous-org-mode-e</a> , but for right now I dont think this is necessary for me so I will go with the raw html formatting from org-export.<br />
</p>

<p>
At this point, I removed all the markdown file stuff from my project as I don't plan to write in markdown and I cleaned up some other stuff I probably wont use. You can see the source code for my project <a href="https://github.com/nkicg6/website-clj">here</a>, all the code that does any work is in the <code>web.clj</code> file.<br />
</p>
</div>

<div id="outline-container-org3c805c1" class="outline-4">
<h4 id="org3c805c1">Links</h4>
<div class="outline-text-4" id="text-org3c805c1">
<p>
Will update when I need it.<br />
use (link-to)<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgbc4ad9b" class="outline-3">
<h3 id="orgbc4ad9b">publishing</h3>
<div class="outline-text-3" id="text-orgbc4ad9b">
</div><div id="outline-container-orga65a50c" class="outline-4">
<h4 id="orga65a50c">Hosting on Github Pages</h4>
<div class="outline-text-4" id="text-orga65a50c">
<p>
From <code>lein</code>, Christian gives some nice instructions, so I followed those to see how the export looks and it seems to work nicely. Now, I'd like put my website on-line and I hosted my previous site on Github Pages, so I need a few config things to occur on export.  The first is the <code>CNAME</code> file, for mapping your domain name to the github repo. A good practice is to empty the target directory before exporting (as Christian did in <code>(stasis/empy-directory!)</code>), and I didn't see any options to exclude certain files, so I added a shell command to part of the export command and placed my <code>CNAME</code> in the <code>resources directory</code>:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.web</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.assets</span> <span style="color: #D0372D;">:as</span> assets<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.export</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.link</span> <span style="color: #D0372D;">:as</span> link<span style="color: #909183;">]</span> 
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.optimizations</span> <span style="color: #D0372D;">:as</span> optimizations<span style="color: #909183;">]</span>      
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.prime</span> <span style="color: #D0372D;">:as</span> optimus<span style="color: #909183;">]</span>                    
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.strategies</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">[</span>serve-live-assets<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.java.io</span> <span style="color: #D0372D;">:as</span> io<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.java.shell</span> <span style="color: #D0372D;">:as</span> shell<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">shell commands from clojure</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #D0372D;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">[</span>html5<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #D0372D;">:as</span> stasis<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">&lt;-----snip-----&gt;</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Christian's original:</span>
<span style="color: #8D8D84;">;;</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(def export-dir "build")</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">(defn export []</span>
<span style="color: #8D8D84;">;;   </span><span style="color: #8D8D84; font-style: italic;">(let [assets (optimizations/all (get-assets) {})]</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">(stasis/empty-directory! export-dir)</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">(optimus.export/save-assets assets export-dir)</span>
<span style="color: #8D8D84;">;;     </span><span style="color: #8D8D84; font-style: italic;">(stasis/export-pages (get-pages) export-dir {</span><span style="color: #8D8D84; font-style: italic;">:optimus-assets</span><span style="color: #8D8D84; font-style: italic;"> assets})))</span>
<span style="color: #8D8D84;">;;   </span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">my edits to include the copy after export. </span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">cp-cname</span> <span style="color: #7388D6;">[</span>export-dir<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">shell</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sh <span style="color: #008000;">"cp"</span> <span style="color: #008000;">"resources/CNAME"</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> export-dir <span style="color: #008000;">"/CNAME"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">export-dir</span> <span style="color: #036A07;">"build"</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">export</span> <span style="color: #7388D6;">[]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">[</span>assets <span style="color: #709870;">(</span><span style="color: #6434A3;">optimizations</span><span style="color: #333333; background-color: #FFFFFF;">/</span>all <span style="color: #907373;">(</span>get-assets<span style="color: #907373;">)</span> <span style="color: #907373;">{}</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>empty-directory! export-dir<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">optimus.export</span><span style="color: #333333; background-color: #FFFFFF;">/</span>save-assets assets export-dir<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>export-pages <span style="color: #709870;">(</span>get-pages<span style="color: #709870;">)</span> export-dir <span style="color: #709870;">{</span><span style="color: #D0372D;">:optimus-assets</span> assets<span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>cp-cname export-dir<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">after export, copy CNAME back to base. </span>

</pre>
</div>

<p>
Now I can keep CNAME where it is supposed to be the whole time. This seems hacky&#x2026; but it also works without me messing up the awesome stasis code.<br />
</p>

<p>
To host on github pages, you also need the static files to be in a repo all by themselves. No problem, since <code>target</code> is already on my <code>.gitignore</code> from my Leiningen project, I can add my static content subdirectory (<code>nickgeorge.net</code>) and start a new repo in there.<br />
Unfortunately, with the previously mentioned problems with <code>(stasis/empty-directory!)</code>, my <code>.git</code> repo is deleted with every <code>lein build-site</code>. Looking in the <a href="https://github.com/magnars/stasis">Stasis code</a>, there doesn't seem to be a way to leave certain files in the target directory alone (There was with my Python Flask setup&#x2026;) while this may be a good and relatively easy way to contribute to the library, for now I am going to do a very horribly inefficient thing and copy the <code>.git</code> directory to a safe space, then back after export. I'll have to do the same with the <code>.gitignore</code><br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.web</span>
  <span style="color: #7388D6;">(</span><span style="color: #D0372D;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.assets</span> <span style="color: #D0372D;">:as</span> assets<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.export</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.link</span> <span style="color: #D0372D;">:as</span> link<span style="color: #909183;">]</span> 
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.optimizations</span> <span style="color: #D0372D;">:as</span> optimizations<span style="color: #909183;">]</span>      
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.prime</span> <span style="color: #D0372D;">:as</span> optimus<span style="color: #909183;">]</span>                    
            <span style="color: #909183;">[</span><span style="color: #6434A3;">optimus.strategies</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">[</span>serve-live-assets<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.java.io</span> <span style="color: #D0372D;">:as</span> io<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.java.shell</span> <span style="color: #D0372D;">:as</span> shell<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">shell commands from clojure</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #D0372D;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">[</span>html5<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #D0372D;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #D0372D;">:as</span> stasis<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">&lt;-----snip-----&gt;</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">export-dir</span> <span style="color: #036A07;">"target/nickgeorge.net"</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">safe-dir</span> <span style="color: #036A07;">"target"</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">cp-cname</span> <span style="color: #7388D6;">[</span>export-dir<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">shell</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sh <span style="color: #008000;">"cp"</span> <span style="color: #008000;">"resources/CNAME"</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> export-dir <span style="color: #008000;">"/CNAME"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">cp-gitignore</span> <span style="color: #7388D6;">[</span>export-dir<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">shell</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sh <span style="color: #008000;">"cp"</span> <span style="color: #008000;">"target/.gitignore"</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> export-dir <span style="color: #008000;">"/.gitignore"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">save-git</span> <span style="color: #7388D6;">[</span>safe-dir export-dir<span style="color: #7388D6;">]</span> 
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">shell</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sh <span style="color: #008000;">"mv"</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> export-dir <span style="color: #008000;">"/.git"</span><span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> safe-dir <span style="color: #008000;">"/.git"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">replace-git</span> <span style="color: #7388D6;">[</span>safe-dir export-dir<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">shell</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sh <span style="color: #008000;">"mv"</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> safe-dir <span style="color: #008000;">"/.git"</span><span style="color: #909183;">)</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">str</span> export-dir <span style="color: #008000;">"/.git"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">export</span> <span style="color: #7388D6;">[]</span>
  <span style="color: #7388D6;">(</span>save-git safe-dir export-dir<span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">copy .git to a safe place</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">let</span> <span style="color: #909183;">[</span>assets <span style="color: #709870;">(</span><span style="color: #6434A3;">optimizations</span><span style="color: #333333; background-color: #FFFFFF;">/</span>all <span style="color: #907373;">(</span>get-assets<span style="color: #907373;">)</span> <span style="color: #907373;">{}</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>empty-directory! export-dir<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">optimus.export</span><span style="color: #333333; background-color: #FFFFFF;">/</span>save-assets assets export-dir<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>export-pages <span style="color: #709870;">(</span>get-pages<span style="color: #709870;">)</span> export-dir <span style="color: #709870;">{</span><span style="color: #D0372D;">:optimus-assets</span> assets<span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
  <span style="color: #7388D6;">(</span>cp-cname export-dir<span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">preserve CNAME</span>
  <span style="color: #7388D6;">(</span>cp-gitignore export-dir<span style="color: #7388D6;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Put .gitignore in</span>
  <span style="color: #7388D6;">(</span>replace-git safe-dir export-dir<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">put .git back</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org32673ac" class="outline-4">
<h4 id="org32673ac">one push publishing with Leiningen :alias</h4>
<div class="outline-text-4" id="text-org32673ac">
<p>
I can already build my website with my current alias, now I will make another to deploy!<br />
The steps I need to do are:<br />
</p>
<ol class="org-ol">
<li>Command line build org-project<br />
<ul class="org-ul">
<li><code>org-publish-project clj-site</code> from the command line<br /></li>
<li>remember to add a header to tell org to <i>not</i> evaluate code like this: <code>#+PROPERTY: header-args :eval never-export</code><br /></li>
<li>This should be a clojure function called with <code>export</code> from <code>build-site</code> <br /></li>
</ul></li>
<li>Then run build-site<br /></li>
<li><code>git add</code> and <code>git push</code> all changes.<br />
<ul class="org-ul">
<li>This could also be a clojure function called with <code>export</code> from <code>build-site</code> <br /></li>
</ul></li>
</ol>

<p>
The idea is that I just call build-site and it all happens automatically. I will adopt Christian's tests as well though.<br />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org4db12c3" class="outline-2">
<h2 id="org4db12c3">References</h2>
<div class="outline-text-2" id="text-org4db12c3">
<ul class="org-ul">
<li><a href="https://github.com/magnars/stasis">Stasis</a><br /></li>
<li><a href="https://github.com/magnars/optimus">Optimus links</a><br /></li>
<li><a href="https://github.com/ring-clojure/ring/wiki/Static-Resources">Ring static middleware</a><br /></li>
<li><a href="https://github.com/yokolet/hiccup-samples">hiccup samples</a><br /></li>
<li>Christian Johansen's post on Building static sites in Clojure with Stasis <a href="https://cjohansen.no/building-static-sites-in-clojure-with-stasis/">https://cjohansen.no/building-static-sites-in-clojure-with-stasis/</a><br />
<ul class="org-ul">
<li>handling links <a href="https://cjohansen.no/optimized-optimus-asset-paths-clojurescript/">https://cjohansen.no/optimized-optimus-asset-paths-clojurescript/</a><br /></li>
<li>Also his post here is similar with some (useful) differences <a href="https://github.com/cjohansen/cjohansen-no/blob/master/resources/md/building-static-sites-in-clojure-with-stasis.md">https://github.com/cjohansen/cjohansen-no/blob/master/resources/md/building-static-sites-in-clojure-with-stasis.md</a><br /></li>
</ul></li>
<li><a href="https://8thlight.com/blog/colin-jones/2010/12/05/clojure-libs-and-namespaces-require-use-import-and-ns.html">Clojure namespaces</a><br /></li>
<li>add more org-mode links!<br /></li>
</ul>
</div>
</div>
