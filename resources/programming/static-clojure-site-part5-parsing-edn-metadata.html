<div id="edn">
{:title "Static clojure site part 5: Parsing edn metadata" :date "2018-08-09" :tags ("clojure" "static-site")}
</div>
<div id="outline-container-org1916247" class="outline-2">
<h2 id="org1916247">What's left to do?</h2>
<div class="outline-text-2" id="text-org1916247">
<ul class="org-ul">
<li>On the index page, automatically list all of the pages in whatever subfolder that index refers to.<br />
<ul class="org-ul">
<li>Add <a href="https://github.com/edn-format/edn">edn</a> metadata to the top of the every page, use this to assign a published date, title, and tags to the posts.<br /></li>
</ul></li>
<li>Add tracking with google analytics or <a href="https://matomo.org/">Matomo</a> (used by <a href="https://www.fsf.org/">FSF</a>)<br /></li>
<li>refactor code for increased simplicity<br /></li>
</ul>
</div>
<div id="outline-container-org4fa7195" class="outline-3">
<h3 id="org4fa7195">All about <code>edn</code> metadata</h3>
<div class="outline-text-3" id="text-org4fa7195">
<ol class="org-ol">
<li>create names of pages based on <code>edn</code> metadata as opposed to just using the file names.<br /></li>
<li>make a list of page with links to them in reverse chronological order (dates from <code>edn</code> metadata) in the appropriate index home page (i.e. a list of programming pages in the programming folder (except index itself&#x2026;) to list in the programming index page, same for science&#x2026;)<br />
<ul class="org-ul">
<li>This will likely be done using enlive to add links to a special div tag placed in the index page body.<br /></li>
</ul></li>
<li>strip <code>edn</code> from the raw html.<br /></li>
</ol>
<p>
This will be done by a function that acts on the map returned by <code>html-pages</code>. I think that is the simplest way to do it.<br />
</p>
</div>
<div id="outline-container-orge3735a6" class="outline-4">
<h4 id="orge3735a6">Read <code>edn</code> metadata</h4>
<div class="outline-text-4" id="text-orge3735a6">
<p>
So in order to use metadata to name, tag, and add dates to pages I'll use a combination of <a href="https://github.com/cgrand/enlive">enlive</a> and Clojure's <a href="https://clojuredocs.org/clojure.edn">edn</a> data format. I'll insert the <code>edn</code> tags at the top of the org mode page (in html tags so it exports) and then parse it using <code>enlive</code> and use this to rename and do all the other fancy stuff with the data. To work on this, I'll add some <code>edn</code> metadata to a test html page and start playing. First I need to add <code>enlive</code> to my <code>project.clj</code><br />
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">project.clj</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defproject</span> <span style="color: #006699;">website-clj</span> <span style="color: #008000;">"0.1.0-SNAPSHOT"</span>
  <span style="color: #006FE0;">:description</span> <span style="color: #008000;">"Personal website built with Clojure, Stasis, and Hiccup"</span>
  <span style="color: #006FE0;">:url</span> <span style="color: #008000;">"http://nickgeorge.net"</span>
  <span style="color: #006FE0;">:license</span> <span style="color: #7388D6;">{</span><span style="color: #006FE0;">:name</span> <span style="color: #008000;">"Eclipse Public License"</span>
            <span style="color: #006FE0;">:url</span> <span style="color: #008000;">"http://www.eclipse.org/legal/epl-v10.html"</span><span style="color: #7388D6;">}</span>
  <span style="color: #006FE0;">:dependencies</span> <span style="color: #7388D6;">[</span><span style="color: #909183;">[</span><span style="color: #6434A3;">org.clojure</span><span style="color: #333333; background-color: #FFFFFF;">/</span>clojure <span style="color: #008000;">"1.8.0"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span>stasis <span style="color: #008000;">"1.0.0"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span>ring <span style="color: #008000;">"1.2.1"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span>hiccup <span style="color: #008000;">"1.0.5"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span><span style="color: #6434A3;">me.raynes</span><span style="color: #333333; background-color: #FFFFFF;">/</span>cegdown <span style="color: #008000;">"0.1.1"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span>optimus <span style="color: #008000;">"0.14.2"</span><span style="color: #909183;">]</span>
                 <span style="color: #909183;">[</span>enlive <span style="color: #008000;">"1.1.6"</span><span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>
  <span style="color: #006FE0;">:ring</span> <span style="color: #7388D6;">{</span><span style="color: #006FE0;">:handler</span> <span style="color: #6434A3;">website-clj.web</span><span style="color: #333333; background-color: #FFFFFF;">/</span>app<span style="color: #7388D6;">}</span>
  <span style="color: #006FE0;">:profiles</span> <span style="color: #7388D6;">{</span><span style="color: #006FE0;">:dev</span> <span style="color: #909183;">{</span><span style="color: #006FE0;">:plugins</span> <span style="color: #709870;">[</span><span style="color: #907373;">[</span>lein-ring <span style="color: #008000;">"0.8.10"</span><span style="color: #907373;">]</span><span style="color: #709870;">]</span><span style="color: #909183;">}</span><span style="color: #7388D6;">}</span>
  <span style="color: #006FE0;">:aliases</span> <span style="color: #7388D6;">{</span><span style="color: #008000;">"build-site"</span> <span style="color: #909183;">[</span><span style="color: #008000;">"run"</span> <span style="color: #008000;">"-m"</span> <span style="color: #008000;">"website-clj.web/export"</span><span style="color: #909183;">]</span><span style="color: #7388D6;">}</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
and then run <code>lein deps</code> at the command line. I'll go through this <a href="https://github.com/swannodette/enlive-tutorial">enlive tutorial</a> to figure out how to parse that portion of the page. My <code>test.org</code> doc looks like this:<br />
</p>

<pre class="example">
=#+HTML: &lt;div class="edn"&gt;=
=#+HTML: {:title "renamed" :date 2018-08-05 :tags (clojure testing post)}=
=#+HTML: &lt;/div&gt;=
=#+OPTIONS: \n:1 toc:nil num:0 todo:nil ^:{}=

=* Here is my test content=

and some code 

=#+BEGIN_SRC clojure=
(test clj-code)
(def test-me "test string")
=#+END_SRC=

</pre>

<p>
As you can see in the header I added the <code>#+HTML</code> tags, which will export literally when I run <code>org-publish-project clj-site</code> I get this:<br />
</p>

<pre class="example">
&lt;div class="edn"&gt;
{:title "renamed" :date 2018-08-05 :tags (clojure testing post)}
&lt;/div&gt;

&lt;div id="outline-container-orgd13af6f" class="outline-2"&gt;
&lt;h2 id="orgd13af6f"&gt;Here is my test content&lt;/h2&gt;
&lt;div class="outline-text-2" id="text-orgd13af6f"&gt;
&lt;p&gt;
and some code&lt;br /&gt;
&lt;/p&gt;

&lt;div class="org-src-container"&gt;
&lt;pre class="src src-clojure"&gt;&lt;span style="color: #707183;"&gt;(&lt;/span&gt;&lt;span style="color: #006FE0;"&gt;test&lt;/span&gt; clj-code&lt;span style="color: #707183;"&gt;)&lt;/span&gt;
&lt;span style="color: #707183;"&gt;(&lt;/span&gt;&lt;span style="color: #0000FF;"&gt;def&lt;/span&gt; &lt;span style="color: #BA36A5;"&gt;test-me&lt;/span&gt; &lt;span style="color: #036A07;"&gt;"test string"&lt;/span&gt;&lt;span style="color: #707183;"&gt;)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

</pre>

<p>
With the useful stuff at the top in the tag. I made a new test folder for this, and I moved the test.html there. So now, I'll read that in and start messing around.<br />
</p>

<p>
I am playing with this code at the bottom of my new <code>process-clj</code> namespace.<br />
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get the test of your first page</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-pages</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>first <span style="color: #709870;">(</span>vals <span style="color: #907373;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                                          <span style="color: #6276BA;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #008000;">""</span> <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
test-pages <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; html for the page</span>
</pre>
</div>

<p>
The <code>first vals</code> from my <code>html-pages</code> function returns a function, and I just call it with an empty string to give me the html text and store it in <code>test-pages</code>. Now I am going to use <code>enlive</code> to scrape it and read the stuff under the <code>edn</code> class div to start manipulating my keys and links.<br />
This took some time, but eventually I figured out this code:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.process-pages</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #006FE0;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">[</span>html5<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">net.cgrand.enlive-html</span> <span style="color: #006FE0;">:as</span> enlive<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">add enlive!</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #006FE0;">:as</span> stasis<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">only for testing?</span>
            <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-pages</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-snippet <span style="color: #909183;">(</span><span style="color: #709870;">(</span>first <span style="color: #907373;">(</span>vals <span style="color: #6276BA;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                                                               <span style="color: #858580;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #008000;">""</span> <span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">selected</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">select</span> test-pages <span style="color: #909183;">[</span><span style="color: #006FE0;">:#edn</span> <span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>text-node<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
selected
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; "\n{</span><span style="color: #8D8D84; font-style: italic;">:title</span><span style="color: #8D8D84; font-style: italic;"> \"renamed\" </span><span style="color: #8D8D84; font-style: italic;">:date</span><span style="color: #8D8D84; font-style: italic;"> 2018-08-05 </span><span style="color: #8D8D84; font-style: italic;">:tags</span><span style="color: #8D8D84; font-style: italic;"> (clojure testing post)}\n"</span>
</pre>
</div>

<p>
Now I'll just read that in as a map using the clojure <code>edn</code> library.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.process-pages</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #006FE0;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">[</span>html5<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">net.cgrand.enlive-html</span> <span style="color: #006FE0;">:as</span> enlive<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.edn</span> <span style="color: #006FE0;">:as</span> edn<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">require edn </span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #006FE0;">:as</span> stasis<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">only for testing?</span>
            <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">get the test of your first page</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-pages</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-snippet <span style="color: #909183;">(</span><span style="color: #709870;">(</span>first <span style="color: #907373;">(</span>vals <span style="color: #6276BA;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                                                               <span style="color: #858580;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #008000;">""</span> <span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">selected</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">select</span> test-pages <span style="color: #909183;">[</span><span style="color: #006FE0;">:#edn</span> <span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>text-node<span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #6434A3;">edn</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">read-string</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">apply</span> str selected<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; {</span><span style="color: #8D8D84; font-style: italic;">:title</span><span style="color: #8D8D84; font-style: italic;"> "renamed" </span><span style="color: #8D8D84; font-style: italic;">:date</span><span style="color: #8D8D84; font-style: italic;"> "2018-08-05" </span><span style="color: #8D8D84; font-style: italic;">:tags</span><span style="color: #8D8D84; font-style: italic;"> ("clojure" "testing" "post")}</span>
</pre>
</div>

<p>
I refactored that into a function using the threading macro like so:<br />
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-html</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span>first <span style="color: #709870;">(</span>vals <span style="color: #907373;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                                         <span style="color: #6276BA;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #008000;">""</span> <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">parse-edn</span>
  <span style="color: #7388D6;">[</span>html<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">-&gt;</span> html
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-snippet<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">select</span> <span style="color: #709870;">[</span><span style="color: #006FE0;">:#edn</span> <span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>text-node<span style="color: #709870;">]</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">-&gt;&gt;</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">apply</span> str<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">I know this is bad form, but it is the best way I know how to do it..</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">edn</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">read-string</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span>parse-edn test-html<span style="color: #707183;">)</span>
<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; {</span><span style="color: #8D8D84; font-style: italic;">:title</span><span style="color: #8D8D84; font-style: italic;"> "renamed" </span><span style="color: #8D8D84; font-style: italic;">:date</span><span style="color: #8D8D84; font-style: italic;"> "2018-08-05" </span><span style="color: #8D8D84; font-style: italic;">:tags</span><span style="color: #8D8D84; font-style: italic;"> ("clojure" "testing" "post")}</span>
</pre>
</div>

<p>
Unfortunately, I need to use <code>(apply str html)</code>, with the html passed as the last argument. The <code>-&gt;</code> macro inserts the result of the previous form as the <i>first</i> argument, which would result in the apply step looking like <code>(apply html str)</code> which will not work. The <code>-&gt;&gt;</code> macro inserts the result of the previous form as the <i>last</i> argument, so added that macro to apply to only the <code>apply str</code> step. I've read mixing these macros is bad form, but for now it seems to work so I'll leave it be.<br />
</p>

<p>
I created another <code>test.html</code> page called <code>test2.html</code>, and I just tested to make sure I could map over it with <code>parse-edn</code>. You'll notice I had to use <code>prepare-pages</code> in order to force the functions to evaluate.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">prepare-page</span> <span style="color: #7388D6;">[</span>page<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">string?</span> page<span style="color: #909183;">)</span> page <span style="color: #909183;">(</span>page <span style="color: #008000;">""</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #006FE0;">map</span> parse-edn
     <span style="color: #7388D6;">(</span><span style="color: #006FE0;">map</span> prepare-page
          <span style="color: #909183;">(</span><span style="color: #006FE0;">vals</span>
           <span style="color: #709870;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                       <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">=&gt;  [{</span><span style="color: #8D8D84; font-style: italic;">:title</span><span style="color: #8D8D84; font-style: italic;"> "renamed" </span><span style="color: #8D8D84; font-style: italic;">:date</span><span style="color: #8D8D84; font-style: italic;"> "2018-08-05" </span><span style="color: #8D8D84; font-style: italic;">:tags</span><span style="color: #8D8D84; font-style: italic;"> ("clojure" "testing" "post")} {</span><span style="color: #8D8D84; font-style: italic;">:title</span><span style="color: #8D8D84; font-style: italic;"> "renamed2" </span><span style="color: #8D8D84; font-style: italic;">:date</span><span style="color: #8D8D84; font-style: italic;"> "2018-08-06" </span><span style="color: #8D8D84; font-style: italic;">:tags</span><span style="color: #8D8D84; font-style: italic;"> ("clojure" "testing2" "post")}]</span>

</pre>
</div>

<p>
Now I made a few changes to <code>parse-edn</code> to get my link generator working quickly. Here is that updated function:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">prepare-page</span> <span style="color: #7388D6;">[</span>page<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">if</span> <span style="color: #909183;">(</span><span style="color: #006FE0;">string?</span> page<span style="color: #909183;">)</span> page <span style="color: #909183;">(</span>page <span style="color: #008000;">""</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">parse-edn</span>
  <span style="color: #7388D6;">[</span>html<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">-&gt;</span> html
      <span style="color: #909183;">(</span>prepare-page<span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">new, render the page if a fn</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-snippet<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">select</span> <span style="color: #709870;">[</span><span style="color: #006FE0;">:#edn</span> <span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>text-node<span style="color: #709870;">]</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #0000FF;">-&gt;&gt;</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">apply</span> str<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">I know this is bad form, but it is the best way I know how to do it..</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">edn</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">read-string</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #006FE0;">get</span> <span style="color: #006FE0;">:title</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">new just return the title for now. </span>
</pre>
</div>

<p>
I just added <code>prepare-page</code> in order to force render the functions, and the <code>(get :title)</code> to return just the title for now. However in my main <code>get-pages</code> function in <code>web.clj</code>, the index pages will be included. Since it would be silly to link to those in the link pages, I will filter those out with a regex. The final form to give me a <code>hash-map</code> of <code>{url-title metadata-title}</code> looks like this:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">remove-index</span> <span style="color: #7388D6;">[</span>values<span style="color: #7388D6;">]</span> <span style="color: #7388D6;">(</span><span style="color: #006FE0;">remove</span> #<span style="color: #909183;">(</span><span style="color: #006FE0;">re-matches</span> #<span style="color: #008000;">"</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">/.*/</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">?index</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">.html</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">?"</span> <span style="color: #BA36A5;">%</span><span style="color: #909183;">)</span> values<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">link-map</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">zipmap</span> <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">keys</span> test-map<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">map</span> parse-edn <span style="color: #907373;">(</span><span style="color: #006FE0;">vals</span> test-map<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
I envision using this in a separate series of functions to create lists of urls for all my pages. Basically, this would be reduced to a single list of href links, which I would pass to a helper function out side of <code>get-pages</code>, which would then insert the list using enlive to the index pages <i>only</i> by using a unique div element. A skeleton looks like so:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">web.clj </span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">define links below</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">list-of-science-links</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>make-links science-map<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">list-of-programming-links</span> <span style="color: #7388D6;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>make-links programming-map<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">below, process/insert-links will add the links to index.html using enlive and a unique selector</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">get-pages</span> <span style="color: #7388D6;">[]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>merge-page-sources
   <span style="color: #909183;">{</span><span style="color: #006FE0;">:landing</span>  <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>home-page <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/home"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:programming</span>  <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>insert-links list-of-programming-links <span style="color: #907373;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/programming"</span> <span style="color: #6276BA;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/programming"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">NEW!</span>
    <span style="color: #006FE0;">:science</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>insert-links list-of-science-links <span style="color: #907373;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/science"</span> <span style="color: #6276BA;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/science"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">NEW</span>
    <span style="color: #006FE0;">:partials</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>partial-pages <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/partials"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:public</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/public"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #709870;">)</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org98b3d70" class="outline-3">
<h3 id="org98b3d70">making links from page lists</h3>
<div class="outline-text-3" id="text-org98b3d70">
<p>
So todo, I need to write a function to make a valid html link, then figure out how to add it to the index page.<br />
</p>

<p>
I'll start tackling these by first addressing the <code>process/make-links</code> problem.  First, I'll make <code>link-map</code>, defined in the previous section into a into a function<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">make a map for urls</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">link-map</span> <span style="color: #7388D6;">[</span>stasis-map<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">zipmap</span> <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">keys</span> stasis-map<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">map</span> parse-edn <span style="color: #907373;">(</span><span style="color: #006FE0;">vals</span> stasis-map<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
Now generating links from these is shown with the following hiccup code (note I had to update my <code>ns</code>):<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.process-pages</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #006FE0;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.core</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">[</span>html<span style="color: #709870;">]</span><span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">just added</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">[</span>html5<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">net.cgrand.enlive-html</span> <span style="color: #006FE0;">:as</span> enlive<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.edn</span> <span style="color: #006FE0;">:as</span> edn<span style="color: #909183;">]</span> 
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #006FE0;">:as</span> stasis<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">only for testing?</span>
            <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>


<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-map</span> <span style="color: #7388D6;">(</span>html-pages <span style="color: #008000;">"/test"</span>
                          <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">I'll work with the map that stasis returns</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">make a map for urls</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">link-map</span> <span style="color: #7388D6;">[</span>stasis-map<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">zipmap</span> <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">keys</span> stasis-map<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
          <span style="color: #909183;">(</span>remove-index <span style="color: #709870;">(</span><span style="color: #006FE0;">map</span> parse-edn <span style="color: #907373;">(</span><span style="color: #006FE0;">vals</span> stasis-map<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">removes index files form the maps. </span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">this makes a list of links with Hiccup. enlive will then insert it.</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">link-list</span> <span style="color: #7388D6;">[</span>links<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>html <span style="color: #909183;">[</span><span style="color: #006FE0;">:ul</span> <span style="color: #709870;">(</span><span style="color: #0000FF;">for</span> <span style="color: #907373;">[</span><span style="color: #6276BA;">[</span>k v<span style="color: #6276BA;">]</span> links<span style="color: #907373;">]</span>
               <span style="color: #907373;">[</span><span style="color: #006FE0;">:li</span> <span style="color: #6276BA;">(</span>link-to k v<span style="color: #6276BA;">)</span><span style="color: #907373;">]</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">returns the html for the list of links. </span>

<span style="color: #707183;">(</span>link-list <span style="color: #7388D6;">(</span>link-map test-map<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">demo how it will run.</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">=&gt; "&lt;ul&gt;&lt;li&gt;&lt;a href=\"/test/test\"&gt;renamed&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=\"/test/test2\"&gt;renamed2&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;"</span>
</pre>
</div>

<p>
Great! Quick refactoring for simplicity:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">make-links</span> <span style="color: #7388D6;">[</span>stasis-map<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">-&gt;</span> stasis-map
      <span style="color: #909183;">(</span>link-map<span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span>link-list<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


<span style="color: #707183;">(</span>make-links test-map<span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">=&gt; "&lt;ul&gt;&lt;li&gt;&lt;a href=\"/test/test\"&gt;renamed&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=\"/test/test2\"&gt;renamed2&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;"</span>
</pre>
</div>

<p>
Now I need to insert a new special <code>&lt;div&gt;</code> tag into my index html, then use enlive to insert these links!<br />
</p>
</div>
</div>

<div id="outline-container-orgc00e66b" class="outline-3">
<h3 id="orgc00e66b">Inserting <code>hiccup</code> html with <code>enlive</code></h3>
<div class="outline-text-3" id="text-orgc00e66b">
<p>
First, I wanted to make sure that I could hide the metadata from the normal page. I <i>could</i> use enlive to actually delete them, but that is really just unnecessary. I don't care if it is in the html, I'd just rather not show it. So I made a css file called <code>hide.css</code> and had it hide all the <code>id=edn</code> divs.<br />
</p>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #0000ff; font-weight: bold;">#edn </span>{
    <span style="color: #00AA00;">display</span>: none;
}
</pre>
</div>

<p>
Easy. Now I will use the <code>include-css</code> hiccup header and add the following to my <code>hiccup</code>-defined header:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">process-pages ns</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">ns</span> <span style="color: #6434A3;">website-clj.process-pages</span>
  <span style="color: #7388D6;">(</span><span style="color: #006FE0;">:require</span> <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.string</span> <span style="color: #006FE0;">:as</span> str<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.core</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">[</span>html<span style="color: #709870;">]</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.page</span> <span style="color: #006FE0;">:use</span> <span style="color: #709870;">[</span>html5 include-css include-js<span style="color: #709870;">]</span><span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">include hiccup helpers</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">hiccup.element</span> <span style="color: #006FE0;">:refer</span> <span style="color: #709870;">(</span>link-to image<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">net.cgrand.enlive-html</span> <span style="color: #006FE0;">:as</span> enlive<span style="color: #909183;">]</span>
            <span style="color: #909183;">[</span><span style="color: #6434A3;">clojure.edn</span> <span style="color: #006FE0;">:as</span> edn<span style="color: #909183;">]</span> 
            <span style="color: #909183;">[</span><span style="color: #6434A3;">stasis.core</span> <span style="color: #006FE0;">:as</span> stasis<span style="color: #909183;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">only for testing?</span>
            <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">layout-base-header</span> <span style="color: #7388D6;">[</span>request page<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span>html5
   <span style="color: #909183;">[</span><span style="color: #006FE0;">:head</span>
    <span style="color: #709870;">[</span><span style="color: #006FE0;">:meta</span> <span style="color: #907373;">{</span><span style="color: #006FE0;">:charset</span> <span style="color: #008000;">"utf-8"</span><span style="color: #907373;">}</span><span style="color: #709870;">]</span>
    <span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">... --- snip ---</span>
    <span style="color: #709870;">(</span>include-css <span style="color: #008000;">"/css/hide.css"</span><span style="color: #709870;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">the new stuff</span>
    <span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">... --- snip ---</span>
    <span style="color: #909183;">]</span>
   <span style="color: #8D8D84;">;;</span><span style="color: #8D8D84; font-style: italic;">Much more here, I cut it out for simplicity</span>
   <span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
Great, I can access all the elements of that like a normal hash-map now.<br />
The element I want to insert the links into is called<br />
</p>
<pre class="example">
&lt;div id="pageListDiv"&gt;Page nav list Here&lt;/div&gt; 
</pre>

<p>
Which will <i>only</i> exist in the index.html pages that should have this list.<br />
</p>
</div>


<div id="outline-container-orgb7b3125" class="outline-4">
<h4 id="orgb7b3125">adding links</h4>
<div class="outline-text-4" id="text-orgb7b3125">
<p>
After a lot of troubleshooting, I finally came up with this.<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">add-links</span> <span style="color: #7388D6;">[</span>page links<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">-&gt;</span> page
      <span style="color: #909183;">(</span>prepare-page<span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">forse eval of lazy pages</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sniptest
       <span style="color: #709870;">[</span><span style="color: #006FE0;">:#pageListDiv</span><span style="color: #709870;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">exists only in index pages. </span>
       <span style="color: #709870;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">content</span> links<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
This can be mapped over the values like so:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">used for testing</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">stasis-map</span> <span style="color: #7388D6;">(</span>html-pages <span style="color: #008000;">"/test"</span> <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-html</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span><span style="color: #006FE0;">first</span> <span style="color: #709870;">(</span><span style="color: #006FE0;">vals</span> stasis-map<span style="color: #709870;">)</span><span style="color: #909183;">)</span> <span style="color: #008000;">""</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span><span style="color: #0000FF;">def</span> <span style="color: #BA36A5;">test-links</span> <span style="color: #7388D6;">(</span>make-links <span style="color: #909183;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">map it!</span>

<span style="color: #707183;">(</span><span style="color: #006FE0;">map</span> #<span style="color: #7388D6;">(</span>add-links <span style="color: #BA36A5;">%</span> test-links<span style="color: #7388D6;">)</span>
     <span style="color: #7388D6;">(</span><span style="color: #006FE0;">vals</span> stasis-map<span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>

</pre>
</div>

<p>
This seems to give the exact output I was looking for. Now when I refer to how it will actually be used:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">web.clj</span>

<span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">--- snip ---</span>

<span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">get-pages</span> <span style="color: #7388D6;">[]</span>
  <span style="color: #7388D6;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>merge-page-sources
   <span style="color: #909183;">{</span><span style="color: #006FE0;">:landing</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>home-page <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/home"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:programming</span>  <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/programming"</span> <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/programming"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:science</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/science"</span> <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/science"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:partials</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>partial-pages <span style="color: #907373;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/partials"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #008000;">html$"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
    <span style="color: #006FE0;">:public</span> <span style="color: #709870;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/public"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #709870;">)</span>

    <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">see below!</span>

    <span style="color: #006FE0;">:test</span> <span style="color: #709870;">(</span>zipmap <span style="color: #907373;">(</span>keys <span style="color: #6276BA;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/test"</span> <span style="color: #858580;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span>
                  <span style="color: #907373;">(</span>map #<span style="color: #6276BA;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>add-links <span style="color: #BA36A5;">%</span> test-links<span style="color: #6276BA;">)</span> <span style="color: #6276BA;">(</span>vals <span style="color: #858580;">(</span><span style="color: #6434A3;">process</span><span style="color: #333333; background-color: #FFFFFF;">/</span>html-pages <span style="color: #008000;">"/test"</span> <span style="color: #80A880;">(</span><span style="color: #6434A3;">stasis</span><span style="color: #333333; background-color: #FFFFFF;">/</span>slurp-directory <span style="color: #008000;">"resources/test"</span> #<span style="color: #008000;">".*</span><span style="color: #000000; font-weight: bold;">\.</span><span style="color: #b39ddb; font-weight: bold;">(</span><span style="color: #008000;">html</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">css</span><span style="color: #b39ddb; font-weight: bold;">|</span><span style="color: #008000;">js</span><span style="color: #b39ddb; font-weight: bold;">)</span><span style="color: #008000;">$"</span><span style="color: #80A880;">)</span><span style="color: #858580;">)</span><span style="color: #6276BA;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">}</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span>


</pre>
</div>

<p>
I still need to return a zipmap like <code>html-pages</code> does, but I also need to use enlive to insert the links.<br />
This technically does what I want, unfortunately all my <code>&gt;</code> characters are escaped as <code>&amp;gt</code>, so the html is not rendering as a list. To fix that, I set up a quick helper function to un-escape those characters and added it like so:<br />
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #0000FF;">defn</span> <span style="color: #006699;">add-links</span> <span style="color: #7388D6;">[</span>page links<span style="color: #7388D6;">]</span>
  <span style="color: #7388D6;">(</span><span style="color: #0000FF;">-&gt;</span> page
      <span style="color: #909183;">(</span>prepare-page<span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">forse eval of lazy pages</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span>sniptest
       <span style="color: #709870;">[</span><span style="color: #006FE0;">:#pageListDiv</span><span style="color: #709870;">]</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">exists only in index pages. </span>
       <span style="color: #709870;">(</span><span style="color: #6434A3;">enlive</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">content</span> links<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">str</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">replace</span> #<span style="color: #008000;">"&amp;gt;"</span> <span style="color: #008000;">"&gt;"</span><span style="color: #909183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">replace greater than</span>
      <span style="color: #909183;">(</span><span style="color: #6434A3;">str</span><span style="color: #333333; background-color: #FFFFFF;">/</span><span style="color: #006FE0;">replace</span> #<span style="color: #008000;">"&amp;lt;"</span> <span style="color: #008000;">"&lt;"</span><span style="color: #909183;">)</span><span style="color: #7388D6;">)</span><span style="color: #707183;">)</span> <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">replace less than</span>
</pre>
</div>

<p>
This works well for my purposes. I need to refactor and work with this a lot, because right now it is not very resilient. For example, if the <code>edn</code> is misformed, or if none of the pages even have the metadata then it will fail with a Java null pointer exception, but for now this will definitely work.<br />
</p>
</div>
</div>
</div>
</div>
